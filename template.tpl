___TERMS_OF_SERVICE___

By creating or modifying this file you agree to Google Tag Manager's Community
Template Gallery Developer Terms of Service available at
https://developers.google.com/tag-manager/gallery-tos (or such other URL as
Google may provide), as modified from time to time.


___INFO___

{
  "type": "TAG",
  "id": "cvt_temp_public_id",
  "version": 1.01,
  "securityGroups": [],
  "displayName": "Mautic Tracking (with User Consent)",
  "categories": [
    "MARKETING",
    "EMAIL_MARKETING"
  ],
  "brand": {
    "id": "brand_suagencia",
    "displayName": "Suagencia",
    "thumbnail": "data:image/png;base64,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\u003d"
  },
  "description": "Initialize Mautic Tracking script. optionally, it can be associated with an user consent (if consent management is being used)",
  "containerContexts": [
    "WEB"
  ]
}


___TEMPLATE_PARAMETERS___

[
  {
    "type": "TEXT",
    "name": "domain",
    "displayName": "Mautic Domain",
    "simpleValueType": true,
    "valueHint": "https://my_mautic_domain.com"
  },
  {
    "type": "SELECT",
    "name": "consent_type",
    "displayName": "Tipo de Consentimento",
    "macrosInSelect": true,
    "selectItems": [
      {
        "value": "ad_storage",
        "displayValue": "ad_storage"
      },
      {
        "value": "analytics_storage",
        "displayValue": "analytics_storage"
      },
      {
        "value": "personalization_storage",
        "displayValue": "personalization_storage"
      },
      {
        "value": "functionality_storage",
        "displayValue": "functionality_storage"
      },
      {
        "value": "security_storage",
        "displayValue": "security_storage"
      }
    ],
    "simpleValueType": true,
    "defaultValue": "personalization_storage"
  }
]


___SANDBOXED_JS_FOR_WEB_TEMPLATE___

// Enter your template code here.
const log = require('logToConsole');
log('data =', data);

const setInWindow = require('setInWindow');
const createArgumentsQueue = require('createArgumentsQueue');
const injectScript = require('injectScript');
const isConsentGranted = require('isConsentGranted');
const addConsentListener = require('addConsentListener');
const callInWindow = require('callInWindow');
const getCookieValues = require('getCookieValues');

let isTagLoaded = false;
if( data.consent_type == undefined ) {
  //if the tag was not associated with a consent type, inject the script without additional checks
  loadTag( data.gtmOnSuccess ,  data.gtmOnFailure );
} else if( isConsentGranted(data.consent_type) ) {
  //if there the tag was associated with a consent type and the consent is granted, inject the script
  loadTag( data.gtmOnSuccess ,  data.gtmOnFailure );
} else {
  //if there the tag was associated with a consent type and but the consent is not granted, listen to consent changes to verify when the script should load
  addConsentListener( data.consent_type, (consentType, granted) => {
     if (!isTagLoaded && consentType === data.consent_type && granted) {
        loadTag();    
      }    
  });
  //notify google the tag was loaded successfully without injecting the main script (due to no consent)
  data.gtmOnSuccess();
}

function loadTag(success, failure) {
  const mt = createArgumentsQueue('mt','mt.q');
  setInWindow('MauticTrackingObject','mt');
  setInWindow('MauticTrackingDomain', data.domain);
   
  mt('send', 'pageview');
  
  injectScript(
    'https://tags.suagencia.online/mtc-2.1.js', 
    ()=>{ 
      isTagLoaded = true;
      log('mautic script loaded'); 
      
      if( success !== undefined) {success();}
    } ,
    ()=>{ 
      log('could not load mautic tracking script');
      if( failure !== undefined ) {failure();}
    },
    data.domain );
}


___WEB_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "logging",
        "versionId": "1"
      },
      "param": [
        {
          "key": "environments",
          "value": {
            "type": 1,
            "string": "debug"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "access_globals",
        "versionId": "1"
      },
      "param": [
        {
          "key": "keys",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "mt"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "MauticTrackingObject"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "mt.q"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "ga"
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "gtag"
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "MauticTrackingDomain"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "inject_script",
        "versionId": "1"
      },
      "param": [
        {
          "key": "urls",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "https://tags.suagencia.online/"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "access_consent",
        "versionId": "1"
      },
      "param": [
        {
          "key": "consentTypes",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "personalization_storage"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "ad_storage"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "analytics_storage"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "functionality_storage"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "security_storage"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "get_cookies",
        "versionId": "1"
      },
      "param": [
        {
          "key": "cookieAccess",
          "value": {
            "type": 1,
            "string": "specific"
          }
        },
        {
          "key": "cookieNames",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "mtc_id"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  }
]


___TESTS___

scenarios:
- name: Regular Load
  code: |2-


    // Call runCode to run the template's code.
    runCode(mockData);

    // Verify that the tag finished successfully.
    assertApi('injectScript').wasCalledWith("https://tags.suagencia.online/mtc-2.1.js", success, failure, mockData.domain);
    assertApi('gtmOnSuccess').wasCalled();
- name: without consent management
  code: "const mockData2 = {\n  domain:\"https://mautic.seuimpresso.com\"  \n};\n\n\
    // Call runCode to run the template's code.\nrunCode(mockData2);\n\n// Verify\
    \ that the tag finished successfully.\nassertApi('injectScript').wasCalledWith(\"\
    https://tags.suagencia.online/mtc-2.1.js\", success, failure, mockData2.domain);\n\
    assertApi('gtmOnSuccess').wasCalled();"
setup: |-
  const mockData = {
    domain:"https://mautic.seuimpresso.com",
    consent_type:"personalization_storage"
    // Mocked field values
  };

  // Create injectScript mock
  let success, failure;
  mock('injectScript', (url, onsuccess, onfailure) => {
    success = onsuccess;
    failure = onfailure;
    onsuccess();
  });


___NOTES___

Created on 1/4/2022, 10:43:09 PM


